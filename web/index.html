<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DPDK AI Engine ‚Äî Live Stats</title>
  <!-- Tailwind CDN (for quick styling) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- TradingView Widget -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { background: #0f172a; color: #e6eef8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.03); }
  </style>
</head>
<body class="min-h-screen p-6">
  <header class="mb-6 flex items-center gap-4">
    <div class="w-12 h-12 bg-white/10 rounded flex items-center justify-center">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="7" height="7" fill="#60A5FA"/><rect x="14" y="3" width="7" height="7" fill="#34D399"/><rect x="3" y="14" width="7" height="7" fill="#F97316"/><rect x="14" y="14" width="7" height="7" fill="#F472B6"/></svg>
    </div>
    <div>
      <h1 class="text-2xl font-bold">DPDK AI Engine ‚Äî Live Stats</h1>
      <p class="text-sm text-slate-300">Auto-updating dashboard. Data source: <code class="mono">/stats.json</code></p>
    </div>
    <div class="ml-auto text-sm text-slate-400">Polling: <span id="poll-interval">2s</span></div>
  <div class="ml-auto text-sm text-slate-400 flex gap-2">
    <button class="tab-btn px-3 py-1 rounded bg-blue-600" data-tab="home">Home</button>
    <button class="tab-btn px-3 py-1 rounded bg-slate-700" data-tab="market">Market Data</button>
  </div>
</header>
  

 <main class="p-6 space-y-6">
  <!-- HOME TAB -->
  <div id="tab-home" class="tab-content">
    <!-- Summary cards -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Summary cards -->
      <section class="lg:col-span-1 space-y-4">
        <!-- Performance Metrics -->
        <div class="card p-4 rounded-lg">
          <h2 class="text-lg font-semibold">Performance Metrics</h2>
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <div>Total Packets: <span id="perf-pkts">-</span></div>
            <div>Total Bytes: <span id="perf-bytes">-</span></div>
            <div>PPS: <span id="perf-pps">-</span></div>
            <div>Throughput (Mbps): <span id="perf-mbps">-</span></div>
            <div>Latency Min: <span id="perf-lat-min">-</span> ms</div>
            <div>Latency Max: <span id="perf-lat-max">-</span> ms</div>
            <div>Latency Avg: <span id="perf-lat-avg">-</span> ms</div>
            <div>Latency P95: <span id="perf-lat-p95">-</span> ms</div>
            <div>Latency P99: <span id="perf-lat-p99">-</span> ms</div>
            <div>Samples: <span id="perf-lat-samples">-</span></div>
        </div>
      </div>
      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">Packet Summary (last 5s)</h2>
        <canvas id="summary-pie" height="180"></canvas>
      </div>

      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">TCP Reassembly</h2>
        <div class="mt-3 text-sm space-y-2">
          <div>Segments: <span id="tcp-seg">‚Äî</span></div>
          <div>Bytes: <span id="tcp-bytes">‚Äî</span></div>
          <div>Duplicates: <span id="tcp-dups">‚Äî</span></div>
          <div>Overlaps: <span id="tcp-ovl">‚Äî</span></div>
          <div>Out-of-order: <span id="tcp-ooo">‚Äî</span></div>
        </div>
      </div>

      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">ARP Entries</h2>
        <div class="overflow-auto max-h-64">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr><th>IP</th><th>MAC</th></tr>
            </thead>
            <tbody id="arp-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">Tunnels</h2>
        <div class="mt-3 text-sm space-y-2">
          <div>GRE: <span id="tun-gre">0 pkts / 0 B</span></div>
          <div>VXLAN: <span id="tun-vxlan">0 pkts / 0 B</span></div>
          <div>GENEVE: <span id="tun-geneve">0 pkts / 0 B</span></div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="lg:col-span-2 space-y-6">
      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">Bandwidth (bps) ‚Äî last N polls</h2>
        <canvas id="chart-line" height="120"></canvas>
      </div>

      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">Per-protocol (pkts / bytes)</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div>
            <canvas id="chart-bar" height="160"></canvas>
          </div>
          <div class="overflow-auto">
            <table class="w-full text-sm mono">
              <thead class="text-slate-300 text-xs p-2">
                <tr><th class="text-left">Proto</th><th class="text-right">Pkts</th><th class="text-right">Bytes</th><th class="text-right">Bps</th></tr>
              </thead>
              <tbody id="proto-table" class="text-slate-200"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">Fragment Table</h2>
        <div class="overflow-auto max-h-64">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr>
                <th>Version</th>
                <th>Src</th>
                <th>Dst</th>
                <th>ID</th>
                <th>Count</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="frag-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4 rounded-lg">
        <h2 class="text-lg font-semibold">DNS Queries</h2>
        <div class="overflow-auto max-h-64">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr><th>QName</th><th>Answer</th></tr>
            </thead>
            <tbody id="dns-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="card p-4 rounded-lg mt-6 lg:col-span-3">
        <h2 class="text-lg font-semibold">Active Flows</h2>
        <div class="overflow-auto max-h-96">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr>
                <th class="text-left">Src</th>
                <th class="text-left">Dst</th>
                <th class="text-left">Proto</th>
                <th class="text-right">Pkts</th>
                <th class="text-right">Bytes</th>
                <th class="text-right">Duration</th>
                <th class="text-right">AvgPkt</th>
                <th class="text-right">Throughput bps</th>
              </tr>
            </thead>
            <tbody id="flows-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4 rounded-lg mt-6 lg:col-span-3">
        <h2 class="text-lg font-semibold">Top Talkers (Last Interval)</h2>
        <div class="overflow-auto max-h-64">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr><th class="text-left">Flow</th><th class="text-left">Proto</th><th class="text-right">Pkts</th><th class="text-right">Bytes</th></tr>
            </thead>
            <tbody id="talkers-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4 rounded-lg mt-6 lg:col-span-3 bg-slate-800">
        <h2 class="text-lg font-semibold text-slate-100">HTTP Sessions</h2>
        <div class="overflow-auto max-h-64 mt-2">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr>
                <th class="text-left">Src</th>
                <th class="text-left">Dst</th>
                <th class="text-left">Host</th>
                <th class="text-left">Method</th>
                <th class="text-left">URI</th>
                <th class="text-left">Status</th>
                <th class="text-right">Pkts</th>
                <th class="text-right">Bytes</th>
              </tr>
            </thead>
            <tbody id="http-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4 rounded-lg mt-6 lg:col-span-3 bg-slate-800">
        <h2 class="text-lg font-semibold text-slate-100">TLS Sessions</h2>
        <div class="overflow-auto max-h-64 mt-2">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr>
                <th class="text-left">Src</th>
                <th class="text-left">Dst</th>
                <th class="text-left">SNI</th>
                <th class="text-left">ALPN</th>
                <th class="text-left">Version</th>
                <th class="text-left">Cipher</th>
                <th class="text-left">Subject</th>
                <th class="text-left">Issuer</th>
              </tr>
            </thead>
            <tbody id="tls-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4 rounded-lg mt-6 lg:col-span-3">
        <h2 class="text-lg font-semibold">DHCP Packets</h2>
        <div class="overflow-auto max-h-64">
          <table class="w-full text-sm mono">
            <thead class="text-slate-300 text-xs p-2">
              <tr><th>XID</th><th>Type</th><th>YiAddr</th></tr>
            </thead>
            <tbody id="dhcp-table" class="text-slate-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- MARKET DATA TAB -->
  <div id="tab-market" class="tab-content hidden">
    <div class="p-4 bg-slate-800 rounded-2xl shadow">
      <h2 class="flex justify-between items-center text-lg font-semibold mb-1 mt-4 bg-orange-600 text-white px-4 py-1 rounded">
        <span>Market Data</span>
        <span id="symbolCount" class="text-sm font-normal"></span>
      </h2>

      <div class="p-4 bg-slate-800 rounded-2xl shadow border border-orange-700">
        <div class="mb-3 flex items-center justify-between gap-2">
          <!-- Filter by State (Left) -->
          <div class="flex items-center gap-2">
            <label for="state-filter" class="text-sm">Filter by State:</label>
            <select id="state-filter" class="text-sm p-1 rounded bg-slate-700 text-white">
              <option value="">All</option>
              <option value="0">AT RESISTANCE</option>
              <option value="1">AT SUPPORT</option>
              <option value="2">BREAKOUT</option>
              <option value="3">RANGE-BOUND</option>
              <option value="4">UNDETERMINED</option> 
            </select>
          </div>

          <!-- Select Categories (Right) -->
          <div class="flex items-center gap-2 relative">
            <label class="text-sm">Select Categories:</label>
            <button id="category-dropdown-btn" class="text-sm p-1 rounded bg-slate-700 text-white">
              Categories
            </button>
            <div id="category-dropdown" class="absolute right-0 mt-1 w-48 max-h-60 overflow-auto bg-slate-800 text-white border border-slate-600 rounded shadow-lg hidden z-50">
              <div class="px-2 py-1">
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="category-checkbox" value="-1" id="category-all">
                  <span>All</span>
                </label>
                </div>
                <div class="px-2 py-1">
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="0">
                    <span>Index</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="1">
                    <span>Auto</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="2">
                    <span>Capital Goods</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="3">
                    <span>Chemicals</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="4">
                    <span>Construction</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="5">
                    <span>Construction Materials</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="6">
                    <span>Consumer Durables</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="7">
                    <span>Consumer Services</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="8">
                    <span>FMCG</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="9">
                    <span>Private Banks</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="10">
                    <span>Public Banks</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="11">
                    <span>Financial Services</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="12">
                    <span>HealthCare</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="13">
                    <span>Information Technology</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="14">
                    <span>Metals & Mining</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="15">
                    <span>Oil & Gas</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="16">
                    <span>Power</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="17">
                    <span>Realty</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="18">
                    <span>Services</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="19">
                    <span>TeleCommunications</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="checkbox" class="category-checkbox" value="20">
                    <span>Textiles</span>
                  </label>
                <!-- Repeat for other categories -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stage Tabs -->
      <div class="flex border-b border-slate-600 mb-0">
        <button 
          id="stage1-tab" 
          class="px-4 py-2 text-sm font-medium text-white bg-purple-700 rounded-t">
          Stage 1
        </button>
        <button 
          id="stage2-tab" 
          class="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white">
          Stage 2
        </button>
      </div>

      <!-- TradingView Chart goes here -->
      
      <!-- Stage 1 Table -->
      <div id="stage1-content">
        <div class="overflow-auto max-h-[800px] min-h-[400px]">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-purple-700 text-white text-xs border-b border-emerald-900 z-10">
              <tr>
                <th class="px-2 py-1 text-left">Symbol</th>
                  <th class="px-2 py-1 text-right">Price</th>
                  <th class="px-2 py-1 text-right">OHLC</th> <!-- Day Open / High / Low / Prev Close -->
                  <th class="px-2 py-1 text-right">52W High</th>
                  <th class="px-2 py-1 text-right">52W Low</th>
                  <th class="px-2 py-1 text-right">Resistance</th>
                  <th class="px-2 py-1 text-right">Support</th>
                  <th class="px-2 py-1 text-right">RS%</th>
                  <th class="px-2 py-1 text-right">ATR</th>
                  <th class="px-2 py-1 text-right">State</th>
                  <th class="px-2 py-1 text-right">Vol (Cur/1D/2D/3D)</th>
                  <th class="px-2 py-1 text-right">Avg Vol 10D</th>
                  <th class="px-2 py-1 text-right">Avg Vol 3M</th>
              </tr>
            </thead>
            <tbody id="market-table" class="text-slate-200">
              <tr>
                <td colspan="4" class="px-2 py-4 text-center text-slate-500">No market data</td>
              </tr>
            </tbody>
          </table>
        </div>  
      </div>
  
      <!-- Stage 2 Content (starts here correctly) -->
      <div id="stage2-content" class="hidden mt-3">
        <h2 class="text-lg font-semibold mb-3 text-white">Stage 2 Dashboard</h2>
        <div class="overflow-auto max-h-[800px] min-h-[400px] border border-orange-700 rounded p-2">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-purple-700 text-white text-xs border-b border-emerald-900 z-10">
              <tr>
                <th class="px-2 py-1 text-left">Symbol</th>
                <th class="px-2 py-1 text-right">Price</th>
                <th class="px-2 py-1 text-right">Support</th>
                <th class="px-2 py-1 text-right">Resistance</th>
                <th class="px-2 py-1 text-right">Delay Alert</th>
                <th class="px-2 py-1 text-right">Burst Alert</th>
                <th class="px-2 py-1 text-left">Remark</th>
              </tr>
            </thead>
            <tbody id="stage2-table" class="text-slate-200">
              <tr>
                <td colspan="7" class="px-2 py-4 text-center text-slate-500">Stage 2 filtering not yet applied</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div> <!-- end stage2-content -->
    </div>
  </div> <!-- end tab-market -->
</main>
 
<footer class="mt-8 text-sm text-slate-400">Updated: <span id="updated">-</span></footer>

<!-- TradingView Modal -->
<div id="tv-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="bg-slate-900 p-4 rounded-lg w-[90%] max-w-4xl">
    <button id="close-tv" class="mb-2 px-3 py-1 bg-red-600 rounded text-white">Close</button>
    <div id="tv-chart" style="height:400px; width:100%;"></div>
  </div>
</div>

<script>
// Configuration
const POLL_INTERVAL_MS = 2000;
const MAX_POINTS = 40;

let lastStats = null;

function fmtBytes(n) { if (n==null) return '-'; const u=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<u.length-1){n/=1024;i++;} return n.toFixed(i?2:0)+' '+u[i]; }
function fmtNum(n){ return (n==null) ? '-' : n.toLocaleString(); }

const symbolMap = {
  "ABB": "NSE:ABB",
  "BSE": "BSE:BSE",
  "CDSL": "NSE:CDSL",
  "HAL": "NSE:HAL",
  "IDEA": "NSE:IDEA",
  "IEX": "NSE:IEX",
  "IGL": "NSE:IGL",
  "NCC": "NSE:NCC",
  "NMDC": "NSE:NMDC",
  "PFC": "NSE:PFC",
  "SAIL": "NSE:SAIL",
  "SIEMENS": "NSE:SIEMENS",
  "TCS": "NSE:TCS",
  "UPL": "NSE:UPL",
  "BEL": "NSE:BEL",
  "BDL": "NSE:BDL",
  "INFY": "NSE:INFY",
  "KEI": "NSE:KEI",
  "MCX": "MCX:MCX",
  "OIL": "NSE:OIL",
  "PRESTIGE": "NSE:PRESTIGE",
  "TITAN": "NSE:TITAN",
  "IOC": "NSE:IOC",
  "RVNL": "NSE:RVNL",
  "BAJAJ-AUTO": "NSE:BAJAJ-AUTO",
};

// Charts
const lineCtx = document.getElementById('chart-line').getContext('2d');
const barCtx = document.getElementById('chart-bar').getContext('2d');
const pieCtx = document.getElementById('summary-pie').getContext('2d');

let lineChart = new Chart(lineCtx, {
  type: 'line', 
  data: { labels:[], datasets:[{label:'bandwidth bps', data:[], borderColor:'#60A5FA', backgroundColor:'rgba(96,165,250,0.12)', tension:0.3}]}, 
  options:{animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}}
});
let barChart = new Chart(barCtx, { 
  type:'bar', 
  data:{ labels:[], datasets:[{label:'pkts', data:[], backgroundColor:'#34D399'},{label:'bytes', data:[], backgroundColor:'#F97316'}]}, 
  options:{animation:false, indexAxis:'x', plugins:{legend:{position:'bottom'}}}
});
let summaryPieChart = new Chart(pieCtx, {
  type: 'pie',
  data: {
    labels: [],
    datasets: [{
      data: [],
      backgroundColor: [
        '#60A5FA','#34D399','#F97316','#F472B6',
        '#EAB308','#8B5CF6','#14B8A6','#F43F5E',
        '#22D3EE','#A3E635'
      ]
    }]
  },
  options: {
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          color: '#E5E7EB'   // legend text color
        }
      }
    }
  }
});

// Market Chart (bar for volume)
let marketChart = null;
const marketCanvas = document.getElementById('market-chart');
if (marketCanvas) {
  marketChart = new Chart(marketCanvas.getContext('2d'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Volume', data: [], backgroundColor: 'rgba(250,204,21,0.7)' }] },
    options: { animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}



// Market Chart
//const marketChart = new Chart(document.getElementById('market-chart').getContext('2d'), {
 // type:'line',
//  data:{labels:[], datasets:[{label:'Price', data:[], borderColor:'#facc15', backgroundColor:'rgba(250,204,21,0.2)', tension:0.3}]},
//  options:{animation:false, plugins:{legend:{display:false}}}
//});

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tabId = 'tab-' + btn.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('bg-blue-600'); b.classList.add('bg-slate-700'); });
    const tabContent = document.getElementById(tabId);
    tabContent.classList.remove('hidden');
    btn.classList.remove('bg-slate-700'); btn.classList.add('bg-blue-600');

    if(tabId==='tab-market' && lastStats){
      updateMarket(lastStats.market, lastStats.alerts);
    }
  });
});

function formatTimestamp(ts_ms) {
    console.log("formatTimestamp input:", ts_ms);
    try {
        const n = Number(ts_ms);
        const d = new Date(n);
        console.log("Converted date:", d.toString());
        return d.toLocaleString("en-IN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false
        }) + "." + String(d.getMilliseconds()).padStart(3, "0");
    } catch (e) {
        console.error("formatTimestamp error", e);
        return "-";
    }
}

const prevPrices = {}; // store previous price per symbol

const STATE_MAP = {
    0: { text: "AT RESISTANCE",      class: "text-yellow-400" },
    1: { text: "AT SUPPORT",         class: "text-green-400" },
    2: { text: "BREAKOUT",           class: "text-red-400" },
    3: { text: "RANGE-BOUND",        class: "text-orange-400" },
    4: { text: "UNDETERMINED",       class: "text-slate-400" }
};

// Helper function to format volumes in K (thousands)
function formatK(num) {
    if (num === undefined || num === null || isNaN(num)) return '-';
    if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + "M";
    if (num >= 1_000) return (num / 1_000).toFixed(1) + "K";
    return num.toString();
}

// Helper function to render mini histogram (bottom aligned)
function renderVolHistogram(vol) {
    if (!vol || !vol.length) return '';
    const maxVol = Math.max(...vol);
    if (maxVol <= 0) return '';

    const minHeight = 3;   // px
    const maxHeight = 24;  // px (container height)

    return `
      <div class="flex items-end gap-1 mt-1 h-[24px]">
        ${vol.map((v, i) => {
            const h = Math.max(minHeight, (v / maxVol) * maxHeight);
            const color = i === 0 ? "bg-green-400" : "bg-yellow-400"; // latest in green
            return `<div class="${color} rounded-sm" style="width:5px; height:${h}px;"></div>`;
        }).join('')}
      </div>
    `;
}

// Keep last prices in memory
const lastPrices = {};

function getPriceInfo(price, prev_close) {
    if (price === undefined || prev_close === undefined || prev_close === 0) {
        return { cls: "text-slate-200", changePct: null, changePts: null, price: '-' };
    }

    const changePts = price - prev_close;
    const changePct = (changePts / prev_close) * 100;

    let cls = "text-slate-200";
    if (changePts > 0) cls = "text-green-400";
    else if (changePts < 0) cls = "text-red-400";

    return { 
        cls, 
        changePct: changePct.toFixed(2),  // percentage change
        changePts: changePts.toFixed(2),  // points change
        price: price.toFixed(2)
    };
}

function getPctChange(price, ref) {
  if (price === undefined || ref === undefined || ref === 0) return null;
  return ((price - ref) / ref * 100).toFixed(2);
}

const dropdownBtn = document.getElementById("category-dropdown-btn");
const dropdown = document.getElementById("category-dropdown");
const allCheckbox = document.getElementById("category-all");

dropdownBtn.addEventListener("click", (e) => {
  dropdown.classList.toggle("hidden");
});

// Close dropdown if clicked outside
document.addEventListener("click", (e) => {
  if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

// Checkbox logic
document.querySelectorAll(".category-checkbox").forEach(cb => {
  cb.addEventListener("change", () => {
    if(cb === allCheckbox) {
      // Toggle all checkboxes
      document.querySelectorAll(".category-checkbox").forEach(c => c.checked = allCheckbox.checked);
    } else {
      // If any individual checkbox is unchecked, uncheck "All"
      if(!cb.checked) allCheckbox.checked = false;

      // If all individual checkboxes are checked, check "All"
      const allInd = Array.from(document.querySelectorAll(".category-checkbox:not(#category-all)"));
      if(allInd.every(c => c.checked)) allCheckbox.checked = true;
    }
    updateMarket(window.marketData, window.alertData);
  });
});

// Make "All" checked initially
allCheckbox.checked = true;

function getSelectedCategories() {
  const selected = Array.from(document.querySelectorAll(".category-checkbox:checked"))
                        .map(cb => parseInt(cb.value));

  // If "All" is checked or nothing else selected, return all category values
  if(selected.includes(-1) || selected.length === 0){
      return Array.from(document.querySelectorAll(".category-checkbox:not(#category-all)")).map(cb => parseInt(cb.value));
  }

  return selected;
}

// Ensure you have these globals somewhere in your app:
let stage1Source = [];    // filtered Stage 1 market (updateMarket should set this)
let stage2Source = [];    // full fetched market (updateMarket should set this)

// Helper that Stage 2 rendering uses:
function getStage2Stocks() {
  // Stage 2 should be based on full feed, not Stage 1 filters.
  // Make sure updateMarket sets stage2Source = [...market] at top.
  if (!stage2Source || stage2Source.length === 0) return [];
  return stage2Source.filter(item => item.state !== 3 && item.state !== 4);
}

// Escape HTML to avoid breaking input
function escapeHTML(str) {
  return String(str || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Render Stage 2 rows (reads from stage2Source)
// Render Stage 2 rows (reads from stage2Source)
function renderStage2(alerts) {
  const tbody = document.getElementById("stage2-table");
  if (!tbody) return;
  tbody.innerHTML = "";

  const stocks = getStage2Stocks();

  // üîπ Update count badge
  const countEl = document.getElementById("symbolCount");
  if (countEl) {
    countEl.textContent = `Symbols: ${stocks.length}`;
  }


  if (!stocks.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="px-2 py-4 text-center text-slate-500">No Stage 2 stocks</td>
      </tr>`;
    return;
  }

  // üîπ Build alert lookup { symbol -> { protocol, burst, delay } }
  const alertMap = {};
  if (alerts) {
    alerts.forEach(a => {
      if (!alertMap[a.symbol]) alertMap[a.symbol] = {};
      alertMap[a.symbol][a.type.toLowerCase()] = a.msg; // normalize key
    });
  }

  stocks.forEach(item => {
    const stateInfo = STATE_MAP[item.state] || { text: "-", class: "" };
    const support =
      item.support !== undefined && item.support !== null
        ? Number(item.support).toFixed(2)
        : "-";
    const resistance =
      item.resistance !== undefined && item.resistance !== null
        ? Number(item.resistance).toFixed(2)
        : "-";
    const rs_pct =
      item.rs_diff_pct !== undefined && item.rs_diff_pct !== null
        ? Number(item.rs_diff_pct).toFixed(2)
        : "-";

    const burstMsg = alertMap[item.symbol]?.burst || ""; // ‚ö° Burst alert
    const burstClass = burstMsg ? "bg-red-600 text-white font-semibold" : "";

    const delayMsg = alertMap[item.symbol]?.delay || ""; // ‚è≥ Delay alert
    const delayClass = delayMsg ? "text-red-400 font-semibold" : "";

    const remark = item.remark || "";  // üîπ use backend-provided remark
    const safeRemark = escapeHTML(remark); // optional: prevent HTML injection

    tbody.innerHTML += `
      <tr>
        <td class="px-2 py-1">${item.symbol}</td>
        <td class="px-2 py-1 text-right">${item.price !== undefined ? Number(item.price).toFixed(2) : "-"}</td>
        <td class="px-2 py-1 text-right">${support}</td>
        <td class="px-2 py-1 text-right">${resistance}</td>
        <td class="px-2 py-1 text-right ${delayClass}">${delayMsg ? "‚è≥ " + delayMsg : ""}</td>
        <td class="px-2 py-1 text-right ${burstClass}">${burstMsg ? "‚ö° " + burstMsg : ""}</td>
        <td class="px-2 py-1 text-left text-green-400">
          ${safeRemark || "-"}
        </td>
      </tr>
    `;
  });
}


// Tab switching
document.getElementById("stage1-tab").addEventListener("click", () => {
  document.getElementById("stage1-content").classList.remove("hidden");
  document.getElementById("stage2-content").classList.add("hidden");

  document.getElementById("stage1-tab").classList.add("bg-purple-700","text-white");
  document.getElementById("stage1-tab").classList.remove("bg-slate-700");

  document.getElementById("stage2-tab").classList.remove("bg-purple-700","text-white");
  document.getElementById("stage2-tab").classList.add("bg-slate-700");
});

document.getElementById("stage2-tab").addEventListener("click", () => {
  document.getElementById("stage2-content").classList.remove("hidden");
  document.getElementById("stage1-content").classList.add("hidden");

  document.getElementById("stage2-tab").classList.add("bg-purple-700","text-white");
  document.getElementById("stage2-tab").classList.remove("bg-slate-700");

  document.getElementById("stage1-tab").classList.remove("bg-purple-700","text-white");
  document.getElementById("stage1-tab").classList.add("bg-slate-700");

  // render Stage 2 with the latest data
  renderStage2();
});


// OPTIONAL: make Stage 2 auto-refresh when updateMarket is run and Stage 2 visible
function refreshStage2IfVisible(alerts) {
  if (!document.getElementById("stage2-content").classList.contains("hidden")) {
    renderStage2(alerts);
  }
}

function updateMarket(market, alerts) {
    console.log("updateMarket called, market length:", market ? market.length : "null");

    console.log("market array:", market);

    if (!market || market.length === 0) {
        // existing Stage 1 empty rendering
        const tbody = document.getElementById('market-table');
        if (tbody) {
            tbody.innerHTML = `<tr>
                <td colspan="12" class="px-2 py-4 text-center text-slate-500">No market data</td>
            </tr>`;
        }
        return;
    }

    stage2Source = [...market];   // full feed

    const tbody = document.getElementById('market-table');
    if (!tbody) return;
    tbody.innerHTML = '';

    const stateFilter = document.getElementById('state-filter').value;
    if(stateFilter !== ''){
      market = market.filter(m => String(m.state) === stateFilter);
    }

    market = market.filter(msg => /^[A-Z0-9.-]+$/.test(msg.symbol));

    const filtered = market.filter(msg => {
        const selectedCategories = getSelectedCategories();
        if (selectedCategories.length > 0 && !selectedCategories.includes(msg.category)) {
          return false;
        }
        // you can also apply state filter here if needed
        return true;
      });

    stage1Source = filtered.slice();  // shallow copy of filtered data
      
    filtered.forEach(msg => {
      const symbol = msg.symbol || '-';

      // Price
      const { cls: priceClass, changePct, changePts, price } = getPriceInfo(msg.price, msg.ohlc?.close);

      // OHLC
      const ohlc = msg.ohlc
          ? `${msg.ohlc.open?.toFixed(2) || '-'} / ${msg.ohlc.high?.toFixed(2) || '-'} / ${msg.ohlc.low?.toFixed(2) || '-'} / ${msg.ohlc.close?.toFixed(2) || '-'}`
          : '-';

      // Support / Resistance / RS%
      const support    = msg.support !== undefined ? msg.support.toFixed(2) : '-';
      const resistance = msg.resistance !== undefined ? msg.resistance.toFixed(2) : '-';
      const rs_diff    = msg.rs_diff_pct !== undefined ? msg.rs_diff_pct.toFixed(2) : '-';

      // 52W High / Low with % diff
      let high52 = "-", highPct = "-", highCls = "text-slate-400";
      let low52 = "-", lowPct = "-", lowCls = "text-slate-400";

      if (msg.high_52wk && msg.price) {
          high52 = msg.high_52wk.toFixed(2);
          highPct = (((msg.high_52wk - msg.price) / msg.high_52wk) * 100).toFixed(2);
          highCls = (highPct > 30) ? "text-red-400" : (highPct < 10 ? "text-green-400" : "text-slate-400");
      }

      if (msg.low_52wk && msg.price) {
          low52 = msg.low_52wk.toFixed(2);
          lowPct = (((msg.price - msg.low_52wk) / msg.low_52wk) * 100).toFixed(2);
          lowCls = (lowPct < 10) ? "text-green-400" : (lowPct > 30 ? "text-red-400" : "text-slate-400");
      }

      // State as string
      const st = STATE_MAP[msg.state] || { text: "Unknown", class: "text-slate-400" };

      // ATR
      const atr = msg.atr !== undefined && msg.atr !== null ? msg.atr.toFixed(2) : '-';

      // Volumes
      const vol = Array.isArray(msg.vol) ? msg.vol : [];

      // Avg Vols
      const avg10d = msg.avg_vol_10d !== undefined ? formatK(msg.avg_vol_10d) : '-';
      const avg3m  = msg.avg_vol_3m  !== undefined ? formatK(msg.avg_vol_3m)  : '-';

      // Ensure vol array is not empty
      const curVol = vol.length ? vol[0] : 0;

      // % vs Avg Volumes
      const pct10d = msg.avg_vol_10d > 0 ? getPctChange(curVol, msg.avg_vol_10d) : "-";
      const pct3m  = msg.avg_vol_3m  > 0 ? getPctChange(curVol, msg.avg_vol_3m) : "-";

      const tvSymbol = symbolMap[symbol] || symbol;

      const tr = document.createElement('tr');
      tr.className = "bg-slate-850 hover:bg-slate-700 transition-colors duration-150"; // same bg for all, subtle hover
      tr.innerHTML = `
          <td class="px-2 py-1 w-24">
              <span class="text-white-800 underline cursor-pointer hover:text-blue-800 symbol-link" data-symbol="${tvSymbol}">
                  ${symbol}
              </span>
          </td>
          <td class="px-2 py-1 w-20 text-right ${priceClass}">
            ${price}
            ${changePts !== null ? `<sub class="ml-1 text-xs">
              ${changePts > 0 ? '‚Üë' : changePts < 0 ? '‚Üì' : ''} ${changePts} (${changePct}%)
            </sub>` : ""}
          </td>

          <td class="px-2 py-1 w-32 text-right">${ohlc}</td>
          <td class="px-2 py-1 w-20 text-right ${highCls}">
            ${high52}
            ${highPct !== "-" ? `<sub class="ml-1 text-xs">${highPct}%</sub>` : ""}
          </td>
          <td class="px-2 py-1 w-20 text-right ${lowCls}">
            ${low52}
            ${lowPct !== "-" ? `<sub class="ml-1 text-xs">${lowPct}%</sub>` : ""}
          </td>
          <td class="px-2 py-1 w-20 text-right">${resistance}</td>
          <td class="px-2 py-1 w-20 text-right">${support}</td>
         
          <td class="px-2 py-1 w-16 text-right">${rs_diff}</td>
          <td class="px-2 py-1 w-20 text-right">
            ${msg.atr !== undefined && msg.atr !== null ? msg.atr.toFixed(2) : '-'}
          </td>
          <td class="px-2 py-1 w-20 text-right ${st.class}">${st.text}</td>
          <td class="px-2 py-1 w-32 text-right">
              ${vol.length ? `<div>${vol.map(v => formatK(v)).join(' / ')}</div>` : '-'}
              ${renderVolHistogram(vol)}
          </td>
          <td class="px-2 py-1 text-right">
            ${avg10d}
            ${pct10d !== "-" ? `<sub class="ml-1 text-xs ${pct10d >= 0 ? 'text-green-600' : 'text-red-600'}">${pct10d}%</sub>` : ""}
          </td>
          <td class="px-2 py-1 text-right">
            ${avg3m}
            ${pct3m !== "-" ? `<sub class="ml-1 text-xs ${pct3m >= 0 ? 'text-green-600' : 'text-red-600'}">${pct3m}%</sub>` : ""}
          </td>
      `;
      tbody.appendChild(tr); 
  });

  // --- Add click listener only to symbol links AFTER rows are added ---
  tbody.querySelectorAll('.symbol-link').forEach(el => {
      el.addEventListener('click', (e) => {
          e.stopPropagation(); // prevent row-level events if any
          const symbol = el.dataset.symbol;
          const row = el.closest("tr");

          const support = parseFloat(row.cells[5].textContent) || undefined;
          const resistance = parseFloat(row.cells[6].textContent) || undefined;

          openTradingView(symbol, support, resistance); // your modal/chart fn
      });
  });

  const rowCount = tbody.querySelectorAll("tr").length;
  document.getElementById("symbolCount").textContent = `Symbols: ${rowCount}`;

  refreshStage2IfVisible(alerts);

}

async function fetchStats(){
  try{
    const res = await fetch('stats.json?_=' + Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const js = await res.json();
    lastStats = js;
    updateUI(js);
  }catch(e){ console.error('fetchStats', e); }
}

// Add point helper
function addPoint(chart,label,value){
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(value);
  if(chart.data.labels.length>MAX_POINTS){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
  chart.update();
}

function updateUI(js) {
  const summary = js.summary || {};
  const perf = summary.perf || {};          // perf stats (p95/p99)
  const perProtoSummary = summary.per_proto || {}; // for pie chart

  // --- Summary Cards ---
  document.getElementById('perf-pkts').textContent = perf.total_pkts ?? '-';
  document.getElementById('perf-bytes').textContent = perf.total_bytes ?? '-';
  document.getElementById('perf-pps').textContent = perf.pps?.toFixed(2) ?? '-';
  document.getElementById('perf-mbps').textContent = perf.mbps?.toFixed(2) ?? '-';
  document.getElementById('perf-lat-min').textContent = perf.latency_min_ms?.toFixed(3) ?? '-';
  document.getElementById('perf-lat-max').textContent = perf.latency_max_ms?.toFixed(3) ?? '-';
  document.getElementById('perf-lat-avg').textContent = perf.latency_avg_ms?.toFixed(3) ?? '-';
  document.getElementById('perf-lat-p95').textContent = perf.latency_p95_ms?.toFixed(3) ?? '-';
  document.getElementById('perf-lat-p99').textContent = perf.latency_p99_ms?.toFixed(3) ?? '-';
  document.getElementById('perf-lat-samples').textContent = perf.latency_samples ?? '-';

  // --- Update Summary Pie Chart ---
  const pieLabels = [], pieData = [];
  for (let key in perProtoSummary) {
    pieLabels.push(key.toUpperCase());
    pieData.push(perProtoSummary[key]);
  }
  summaryPieChart.data.labels = pieLabels;
  summaryPieChart.data.datasets[0].data = pieData;
  summaryPieChart.update();

  // --- Fragments Table ---
  const fragTable = document.getElementById('frag-table');
  if (fragTable) {
    fragTable.innerHTML = '';
    const frags = js.fragments || [];
    frags.forEach(f => {
      const tr = document.createElement('tr');
      const statusColor = f.status === "DONE" ? "text-green-400" : "text-yellow-400";
      tr.innerHTML = `<td>${f.version}</td><td>${f.src}</td><td>${f.dst}</td>
                      <td>${f.id}</td><td class="text-right">${f.count}</td>
                      <td class="${statusColor}">${f.status}</td>`;
      fragTable.appendChild(tr);
    });
  }

  // --- TCP Reassembly ---
  const tr = js.tcp_reassembly || {};
  document.getElementById('tcp-seg').textContent = fmtNum(tr.segments);
  document.getElementById('tcp-bytes').textContent = fmtBytes(tr.bytes);
  document.getElementById('tcp-dups').textContent = fmtNum(tr.duplicates);
  document.getElementById('tcp-ovl').textContent = fmtNum(tr.overlaps);
  document.getElementById('tcp-ooo').textContent = fmtNum(tr.out_of_order);


  // --- Tunnels ---
  const t = js.tunnels || {};
  document.getElementById('tun-gre').textContent = (t.gre_pkts||0)+' pkts / '+(t.gre_bytes||0)+' B';
  document.getElementById('tun-vxlan').textContent = (t.vxlan_pkts||0)+' pkts / '+(t.vxlan_bytes||0)+' B';
  document.getElementById('tun-geneve').textContent = (t.geneve_pkts||0)+' pkts / '+(t.geneve_bytes||0)+' B';

  // --- Bandwidth Line Chart ---
  const now = new Date();
  const bps = (js.per_protocol && js.per_protocol.reduce)
  ? js.per_protocol.reduce((a,b)=>a+(b.bandwidth_bps||0),0) 
  : (s.bandwidth_kbps? s.bandwidth_kbps*1000 : 0);
  addPoint(lineChart, now.toLocaleTimeString(), Math.round(bps));

  // --- Per-Protocol Table & Bar Chart ---
  const protoTable = document.getElementById('proto-table'); protoTable.innerHTML = '';
  const per = js.per_protocol || [];
  const labels = [], pktsData = [], bytesData = [];
  per.forEach(p => {
    labels.push(p.proto);
    pktsData.push(p.pkts||0);
    bytesData.push(Math.round(p.bytes||0));

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.proto}</td><td class="text-right">${(p.pkts||0).toLocaleString()}</td><td class="text-right">${(p.bytes||0).toLocaleString()}</td><td class="text-right">${(p.bandwidth_bps||0).toLocaleString()}</td>`;
    protoTable.appendChild(tr);
  });
  barChart.data.labels = labels; barChart.data.datasets[0].data = pktsData; barChart.data.datasets[1].data = bytesData; barChart.update();

  document.getElementById('updated').textContent = new Date().toLocaleTimeString();

   // --- Active Flows ---
  const flowsTable = document.getElementById('flows-table');
  if (flowsTable) {
    flowsTable.innerHTML = ''; // clear old rows
    const flows = js.flows || [];
    flows.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.src}</td><td>${f.dst}</td><td>${f.proto}</td>
                      <td class="text-right">${f.pkts}</td><td class="text-right">${f.bytes}</td>
                      <td class="text-right">${f.duration_sec.toFixed(3)}</td>
                      <td class="text-right">${f.avg_pkt_bytes.toFixed(1)}</td>
                      <td class="text-right">${Math.round(f.throughput_bps)}</td>`;
      flowsTable.appendChild(tr);
    });
  }

  // --- Top Talkers ---
  const talkersTable = document.getElementById('talkers-table');
  if (talkersTable) {
    talkersTable.innerHTML = ''; // clear old rows
    const talkers = js.top_talkers || []; // use "top_talkers" key from JSON
    talkers.forEach(t => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.flow}</td><td>${t.proto}</td>
                      <td class="text-right">${t.pkts}</td><td class="text-right">${t.bytes}</td>`;
      talkersTable.appendChild(tr);
    });
  }

  // --- DNS ---
  const dnsTable = document.getElementById('dns-table');
  if(dnsTable){
    dnsTable.innerHTML = '';
    (js.dns || []).forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.qname}</td><td>${d.answer}</td>`;
      dnsTable.appendChild(tr);
    });
  }

  // --- ARP ---
  const arpTable = document.getElementById('arp-table');
  if(arpTable){
    arpTable.innerHTML = '';
    (js.arp || []).forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.ip}</td><td>${a.mac}</td>`;
      arpTable.appendChild(tr);
    });
  }

  // --- DHCP ---
  const dhcpTable = document.getElementById('dhcp-table');
  if(dhcpTable){
    dhcpTable.innerHTML = '';
    (js.dhcp || []).forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.xid}</td><td>${d.type}</td><td>${d.yiaddr}</td>`;
      dhcpTable.appendChild(tr);
    });
  }

  // --- HTTP Table ---
  const httpTable = document.getElementById('http-table');
    if(httpTable){
    httpTable.innerHTML = '';
    (js.http_sessions || []).forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${s.src}</td>
            <td>${s.dst}</td>
            <td>${s.host}</td>
            <td>${s.method}</td>
            <td>${s.uri}</td>
            <td>${s.status || '-'}</td>
            <td class="text-right">${s.pkts}</td>
            <td class="text-right">${s.bytes}</td>
        `;
        httpTable.appendChild(tr);
    });
  }

  // --- TLS Table ---
  const tlsTable = document.getElementById('tls-table');
    if(tlsTable){
    tlsTable.innerHTML = '';
    (js.tls_sessions || []).forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
          <td>${s.src}</td>
          <td>${s.dst}</td>
          <td>${s.sni}</td>
          <td>${s.alpn}</td>
          <td>${s.version}</td>
          <td>${s.cipher}</td>
          <td>${s.subject}</td>
          <td>${s.issuer}</td>
      `;
      tlsTable.appendChild(tr);
   });
 }

   // Market (only if tab visible)
  if(!document.getElementById('tab-market').classList.contains('hidden')){
    updateMarket(js.market, js.alerts);
  }

  document.getElementById('state-filter').addEventListener('change', () => {
    if(lastStats) updateMarket(lastStats.market, lastStats.alerts);
  });
  // --- Updated Timestamp ---
  document.getElementById('updated').textContent = new Date().toLocaleTimeString();
}

const tvModal = document.getElementById('tv-modal');
const tvChartContainer = document.getElementById('tv-chart');
document.getElementById('close-tv').addEventListener('click', () => tvModal.classList.add('hidden'));

function openTradingView(symbol, support, resistance) {
  tvModal.classList.remove('hidden');
  tvChartContainer.innerHTML = ""; // reset previous chart

  new TradingView.widget({
    width: "100%",
    height: 400,
    symbol: symbol,
    interval: "D",
    timezone: "Etc/UTC",
    theme: "dark",
    style: "1",
    container_id: "tv-chart",
    studies_overrides: {},
    overrides: {
      "paneProperties.background": "#0f172a",
      "paneProperties.gridProperties.color": "#1e293b"
    },
    onChartReady: function(chart) {
      // Add horizontal lines for support & resistance
      if (support !== undefined) chart.createMultipointShape([{ time: Date.now(), price: support }], { shape: 'horizontal_line', color: 'green' });
      if (resistance !== undefined) chart.createMultipointShape([{ time: Date.now(), price: resistance }], { shape: 'horizontal_line', color: 'red' });
    }
  });
}

// poll
setInterval(fetchStats, POLL_INTERVAL_MS);
fetchStats();

</script>
</body>
</html>
